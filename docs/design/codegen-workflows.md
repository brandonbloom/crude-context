# Codegen workflows (OpenAPI → generated bindings)

This document summarizes the common “shape” of code generation across Crude repos. Details vary by ecosystem, but the contract is consistent: the OpenAPI spec is generated by `crude-openapi`, and downstream repos generate bindings/types from that spec.

## Canonical sources

- Spec generator: `crude-openapi` (meta-spec in `crude-openapi/src/spec/*`)
- Full generated spec example: `crude-openapi/build/spec.json`
- Conformance suite: `crude-openapi/src/tests/hurl/*.hurl` (run via `crude-openapi test`)

## Common pipeline

1) Generate an OpenAPI JSON file using `crude-openapi generate ...`
2) Generate language/framework bindings from that JSON (oapi-codegen, openapi-typescript, etc.)
3) Do not hand-edit generated outputs; regenerate instead.

## Common flags (observed)

- `--openapi-version`: typically 3.0.0 or 3.1.0
- `--server-url`: one or more base URLs for clients
- `--root-domain`, `--domains`: include desired namespace shapes (unscoped `/collections/...` vs scoped `/domains/{domain}/...`)
- `--erase-generics`: choose whether to erase/instantiate generic schemas for simpler downstream codegen

## Repo examples (current)

- Go (`crude-go`)
  - Generates OpenAPI JSON, then generates `generated.go` via `oapi-codegen`.
  - See: `crude-go/DEVELOPING.md`, `crude-go/mise.toml`, `crude-go/internal/openapi/`

- Swift (`crude-swift`)
  - Generates OpenAPI JSON (multiple outputs) and uses it for the server package.
  - See: `crude-swift/mise.toml`

- Web UI (`crude-web`)
  - Generates `src/lib/openapi.json` and then TypeScript types (`api.d.ts`) via `openapi-typescript`.
  - See: `crude-web/mise.toml`

- JS/TS monorepo (`crude-js`)
  - Pulls spec from `crude-openapi` and uses it in its packages’ build/test flows.
  - See: `crude-js/mise.toml`

## When changing the protocol

1) Update the meta-spec in `crude-openapi` (and/or its conformance suite).
2) Rebuild/re-run `crude-openapi` to produce updated OpenAPI JSON.
3) Update downstream repos by re-running their `mise run generate` (or equivalent).
4) Run the shared conformance suite against implementations (`crude-openapi test --server ...`).
